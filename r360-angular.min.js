"use strict";angular.module("ng360",[]).factory("r360Angular",[function($scope,$q,$location,$timeout,$http){function getColorRange(){return prefs.colorRanges[self.colorRange]}function normalizeLatLng(coords){var result={lat:void 0,lng:void 0};return"undefined"!=typeof coords.lat&&"undefined"!=typeof coords.lng&&(result.lat=parseFloat(coords.lat.toFixed(6)),result.lng=parseFloat(coords.lng.toFixed(6))),"undefined"!=typeof coords[0]&&"undefined"!=typeof coords[1]&&(result.lat=parseFloat(coords[0].toFixed(6)),result.lng=parseFloat(coords[1].toFixed(6))),coords}function reverseGeocode(coords){var url="",deferred=$q.defer();return"undefined"!=typeof coords.lat&&"undefined"!=typeof coords.lng&&(url="https://service.route360.net/geocode/reverse?lon="+coords.lng+"&lat="+coords.lat),"undefined"!=typeof coords[0]&&"undefined"!=typeof coords[1]&&(url="https://service.route360.net/geocode/reverse?lon="+coords[1]+"&lat="+coords[0]),$http({method:"GET",url:url}).then(function(response){var properties={};response.data.features.length>0?(properties=response.data.features[0].properties,"undefined"==typeof properties.name&&(properties.name="","undefined"!=typeof properties.street&&(properties.name+=properties.street),"undefined"!=typeof properties.housenumber&&(properties.name+=" "+properties.housenumber))):properties={name:"Marker",city:"",country:""},deferred.resolve(properties)},function(response){}),deferred.promise}function getTravelOptions(){var travelOptions=r360.travelOptions(),travelTime=60*self.travelTime,travelTimes=[],defaultColors=[];if(prefs.travelTimeRanges[self.travelTimeRange].times.forEach(function(elem,index,array){var dataSet={};dataSet.time=60*elem,dataSet.color=prefs.colorRanges[self.colorRange].colors[index],dataSet.opacity=prefs.colorRanges[self.colorRange].opacities[index],defaultColors.push(dataSet)}),r360.config.defaultTravelTimeControlOptions.travelTimes=defaultColors,"inverse"==self.colorRange?travelTimes.push(travelTime):defaultColors.forEach(function(elem,index,array){elem.time<=travelTime&&travelTimes.push(elem.time)}),travelOptions.setTravelTimes(travelTimes),travelOptions.setTravelType(self.travelType),self.sourceMarkers.forEach(function(elem,index,array){travelOptions.addSource(elem),elem.id=1e5*Math.random()}),self.targetMarkers.forEach(function(elem,index,array){travelOptions.addTarget(elem)}),travelOptions.extendWidthX=2*self.extendWidth,travelOptions.extendWidthY=2*self.extendWidth,travelOptions.setIntersectionMode(self.intersection),"transit"==self.travelType){var date=String(self.queryDate.getFullYear())+("0"+String(self.queryDate.getMonth())).slice(-2)+("0"+String(self.queryDate.getDate())).slice(-2);travelOptions.setDate(date);var rawTime=self.queryTime,time=3600*rawTime.h+60*rawTime.m;travelOptions.setTime(time)}return travelOptions.setMinPolygonHoleSize(3600*self.travelTime*2e3),travelOptions}var now=new Date,hour=now.getHours(),minute=(now.getMinutes()+(5-now.getMinutes()%5))%60;0===minute&&hour++,24===hour&&(hour=0);var self={serviceKey:"6RNT8QMSOBQN0KMFXIPD",travelTime:30,travelTimeRange:"5to30",travelType:"transit",queryTime:{h:hour,m:minute},queryDate:now,colorRange:"default",sourceMarkers:[],targetMarkers:[],intersection:"union",strokeWidth:20,extendWidth:500,backgroundColor:"black",backgroundOpacity:1,placesLimit:100,transition:!0,mapstyle:"https://cartodb-basemaps-c.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png",showAdvanced:!1,showSourceMarkers:!0,showTargetMarkers:!1,showSourceIsochrones:!1,showTargetIsochrones:!1,singleMarkerMode:!0,maxSourceMarkers:5,maxTargetMarkers:5,customMode:!1,newU5:!1,endpoint:"brandenburg",normalizeLatLng:normalizeLatLng,getColorRange:getColorRange,reverseGeocode:reverseGeocode,getTravelOptions:getTravelOptions},prefs={home:{latlng:[52.5167,13.3833]},endpoints:{oldU5:"https://service.route360.net/brandenburg/",newU5:"https://service.route360.net/u5/"},travelTypes:[{name:"Bike",icon:"md:bike",value:"bike"},{name:"Walk",icon:"md:walk",value:"walk"},{name:"Car",icon:"md:car",value:"car"},{name:"Transit",icon:"md:train",value:"transit"}],queryTimeRange:{hour:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],minute:[0,5,10,15,20,25,30,35,40,45,50,55]},mapProviderList:[{name:"OpenStreetMaps",value:"osm"},{name:"Google Maps",value:"google"}],intersectionTypes:[{name:"Union",value:"union"},{name:"Intersection",value:"intersection"},{name:"Average",value:"average"}],travelTimeRanges:[{name:"5 Min - 30 Min",id:"5to30",times:[5,10,15,20,25,30]},{name:"10 Min - 60 Min",id:"10to60",times:[10,20,30,40,50,60]},{name:"20 Min - 120 Min",id:"20to120",times:[20,40,60,80,100,120]}],colorRanges:[{name:"Green to Red",id:"default",colors:["#006837","#39B54A","#8CC63F","#F7931E","#F15A24","#C1272D"],opacities:[1,1,1,1,1,1]},{name:"Colorblind",id:"colorblind",colors:["#142b66","#4525AB","#9527BC","#CE29A8","#DF2A5C","#F0572C"],opacities:[1,1,1,1,1,1]},{name:"Greyscale",id:"greyscale",colors:["#d2d2d2","#b2b2b2","#999999","#777777","#555555","#333333"],opacities:[1,.8,.6,.4,.2,0]},{name:"Inverse Mode (B/W)",id:"inverse",colors:["#777777"],opacities:[1,1,1,1,1,1]}],mapStyles:[{name:"Light",value:"https://cartodb-basemaps-c.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png"},{name:"Dark",value:"https://cartodb-basemaps-c.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png"},{name:"OSM Standard",value:"http://tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png"}]};return r360.config.defaultPolygonLayerOptions.backgroundOpacity=.3,r360.config.requestTimeout=1e4,r360.config.serviceUrl="https://service.route360.net/"*self.endpoint,r360.config.serviceKey=self.serviceKey,r360.config.i18n.language="de",self}]);